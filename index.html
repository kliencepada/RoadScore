<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoadScore | Quality Reporter</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <style>
    /* CRITICAL FIX: LEAFLET SIZING FIX */
    .leaflet-container {
        height: 100%; 
    }

    /* --- 1. GLOBAL STYLES --- */
    :root {
        --primary: #2563eb; 
        --primary-hover: #1d4ed8;
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --star-color: #ffc107; 
        --success-color: #2ecc71; 
        --warning-color: #f39c12; 
        --critical-color: #e74c3c; 
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    /* --- CRITICAL FIX: CONSISTENT NAVBAR HEIGHT --- */
    /* 1. Remove default vertical padding from the main navbar element */
    .navbar {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }
    /* 2. Apply explicit and equal vertical padding to the brand and links for consistent height */
    .navbar-brand, .navbar-nav .nav-link {
        padding-top: 0.75rem !important; 
        padding-bottom: 0.75rem !important;
    }

    /* --- FIX: NAVBAR ACTIVE LINK CONSISTENCY (Applied to index.html) --- */
    .navbar-nav .nav-item .nav-link.active {
        background-color: var(--primary-hover); 
        border-radius: 0px; 
    }
    .navbar-nav .nav-item {
        padding: 0 5px;
    }

    .app-container {
        display: flex;
        flex: 1; 
        overflow: hidden;
    }

    /* --- 3. SIDEBAR (Form Area) --- */
    .sidebar {
        width: 400px;
        background: var(--card-bg);
        padding: 2rem;
        overflow-y: auto;
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        box-shadow: 4px 0 15px rgba(0,0,0,0.05);
        z-index: 1000;
    }

    header h1 {
        font-size: 1.8rem;
        color: var(--primary);
        font-weight: 800;
        margin-bottom: 0.2rem;
    }

    header p {
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    hr {
        border: 0;
        height: 1px;
        background: #e5e7eb;
        margin: 1rem 0;
    }

    /* --- 4. FORM STYLING --- */
    h3 {
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.8rem;
        font-weight: 700;
    }

    label {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
        display: block;
    }

    select, textarea, input[type="text"], input[type="file"] {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-family: inherit;
        margin-bottom: 1rem;
        transition: border-color 0.2s;
        background: #f9fafb;
    }

    select:focus, textarea:focus, input[type="text"]:focus {
        outline: none;
        border-color: var(--primary);
        background: #fff;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea {
        resize: vertical;
    }

    /* --- 5. BUTTON STYLING --- */
    button#submit-btn {
        width: 100%;
        padding: 0.85rem;
        background-color: var(--success-color); 
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }

    button#submit-btn:hover:not(:disabled) {
        background-color: #27ae60;
    }

    button:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
        opacity: 0.7;
    }

    #status-msg {
        display: block;
        margin-top: 10px;
        font-size: 0.9rem;
        text-align: center;
        font-weight: 600;
        min-height: 1.2em;
    }

    /* --- 6. RECENT REPORTS LIST --- */
    #reports-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .report-item {
        background: var(--bg-color);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid var(--primary); 
        font-size: 0.9rem;
    }
    
    .report-item strong {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
        font-size: 1rem;
        color: var(--text-main);
    }

    .report-item .stars {
        color: var(--star-color);
        font-size: 1.1rem;
        margin-right: 8px;
    }

    .report-item small:last-child {
        display: block;
        margin-top: 5px;
        color: var(--text-muted);
        font-size: 0.75rem;
    }

    .report-img {
        width: 100%;
        max-height: 200px;
        object-fit: cover;
        border-radius: 6px;
        margin-top: 8px;
        border: 1px solid #ddd;
    }
    
    /* Style for the trash icon button */
    .report-item .btn-sm {
        line-height: 1; 
        font-size: 0.8rem;
    }

    /* --- 7. MAP AREA --- */
    .map-wrapper {
        flex: 1;
        position: relative;
    }

    #map {
        width: 100%;
        height: 100%;
        z-index: 1;
    }

    .map-instructions {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 16px;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 999;
        font-size: 0.85rem;
        font-weight: 600;
        color: #4b5563;
        pointer-events: none;
    }

    .leaflet-popup-content img {
        max-width: 200px !important; 
        width: 100%;
        border-radius: 4px;
        margin-top: 5px;
    }
    
    .leaflet-marker-icon {
        border-radius: 50%;
        box-shadow: 0 0 5px rgba(0,0,0,0.5);
        border: 2px solid white;
    }

    /* --- 8. RESPONSIVE (MOBILE) --- */
    @media (max-width: 900px) {
        .app-container {
            flex-direction: column-reverse; 
            height: auto;
            min-height: 100vh;
        }

        .sidebar {
            width: 100%;
            height: auto;
            overflow: visible;
            border-right: none;
            border-top: 1px solid #e5e7eb;
        }

        .map-wrapper {
            height: 50vh; 
            flex: none;
        }
    }
</style>
</head>

<body>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid container">
        
        <a class="navbar-brand" href="index.html">RoadScore üö¶</a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="index.html">Reports Map</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="testimonies.html">Testimonies</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="about.html">About</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
    
    <div class="app-container">
        
        <aside class="sidebar">
            <header>
                <h1>Report a Road Score</h1>
                <p>Click on the map to pin a location and submit a report.</p>
                <hr>
            </header>

            <form id="report-form">
                <h3>1. Report Details</h3>
                
                <label for="category">Road Rating</label>
                <select id="category" required>
                    <option value="">-- Select Rating --</option>
                    <option value="0">0 - Unusable (Critical)</option>
                    <option value="1">‚≠ê - Very Poor</option>
                    <option value="2">‚≠ê‚≠ê - Poor</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê - Average</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê - Good</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê - Excellent</option>
                </select>
                
                <label for="description">Description</label>
                <textarea id="description" rows="3" placeholder="Describe potholes, traffic, surface quality..."></textarea>
                
                <label for="imageInput">Attach Photo (Optional)</label>
                <input type="file" id="imageInput" accept="image/*">
                
                <hr>

                <h3>2. Pin Location</h3>
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">Click on the map to set the marker.</p>

                <button type="submit" id="submit-btn" disabled>Submit Report</button>
                <span id="status-msg"></span>
            </form>

            <div style="margin-top: auto;">
                <h3>Recent Reports</h3>
                <div id="reports-list">
                    <p style="color: #999; font-style: italic;">No reports yet.</p>
                </div>
            </div>
        </aside>

        <main class="map-wrapper">
            <div class="map-instructions">Tip: Use the layers icon (top-right) to filter ratings!</div>
            <div id="map"></div>
        </main>

    </div>
    
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Delete Report <span id="modal-report-id"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="delete-reason-form">
              <div class="modal-body">
                  <p>Please select the reason for deleting this report:</p>
                  
                  <div class="form-check">
                      <input class="form-check-input reason-radio" type="radio" name="deleteReason" id="reason1" value="Incorrect Map Pin Location (Pin Error)" required>
                      <label class="form-check-label" for="reason1">1. Incorrect Map Pin Location (Pin Error)</label>
                  </div>
                  <div class="form-check">
                      <input class="form-check-input reason-radio" type="radio" name="deleteReason" id="reason2" value="Road Condition Has Been Repaired/Fixed">
                      <label class="form-check-label" for="reason2">2. Road Condition Has Been Repaired/Fixed</label>
                  </div>
                  <div class="form-check">
                      <input class="form-check-input reason-radio" type="radio" name="deleteReason" id="reason3" value="Duplicate Report Entry">
                      <label class="form-check-label" for="reason3">3. Duplicate Report Entry</label>
                  </div>
                  <div class="form-check">
                      <input class="form-check-input reason-radio" type="radio" name="deleteReason" id="reason4" value="Submitted Information Was Inaccurate">
                      <label class="form-check-label" for="reason4">4. Submitted Information Was Inaccurate</label>
                  </div>
                  <div class="form-check">
                      <input class="form-check-input reason-radio" type="radio" name="deleteReason" id="reason5" value="Mistake: Accidentally submitted the report">
                      <label class="form-check-label" for="reason5">5. Mistake: Accidentally submitted the report</label>
                  </div>
                  
                  <hr>
                  
                  <div class="form-check">
                      <input class="form-check-input reason-radio" type="radio" name="deleteReason" id="reason6" value="Other" required>
                      <label class="form-check-label" for="reason6">6. Other (Specify below)</label>
                  </div>
                  <textarea id="otherReasonText" class="form-control mt-2" rows="2" placeholder="Please specify the reason if you chose 'Other'" disabled></textarea>
                  
                  <div id="other-reason-error" class="text-danger mt-2" style="display: none;">
                      Please enter a custom reason or select another option.
                  </div>
                  
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Confirm Deletion</button>
              </div>
          </form>
        </div>
      </div>
    </div>

    <script>
        const REPORTS_STORAGE_KEY = 'roadscore_reports'; // üí° NEW: Storage key for reports

        var map;
        var tempMarker = null;
        var selectedLat = null;
        var selectedLng = null;
        
        var currentDeleteReportId = null;

        // Storage for all reports: now loaded from localStorage on start
        var reports = {}; 
        var reportCounter = 0; // Will be updated to the max ID from loaded reports

        // --- Local Storage Functions ---
        function loadReports() {
            const storedReports = localStorage.getItem(REPORTS_STORAGE_KEY);
            let loadedReports = storedReports ? JSON.parse(storedReports) : {};

            // Update reportCounter to prevent duplicate IDs after page refresh
            let maxId = 0;
            if (Object.keys(loadedReports).length > 0) {
                // Find the highest ID among all loaded reports
                maxId = Math.max(...Object.keys(loadedReports).map(id => parseInt(id)));
            }
            reportCounter = maxId;

            return loadedReports;
        }

        function saveReports(reportsObject) {
            localStorage.setItem(REPORTS_STORAGE_KEY, JSON.stringify(reportsObject));
        }

        // --- Helper Functions ---
        function getStarRating(value) {
            const num = parseInt(value);
            if (num === 0) return '0 - Unusable';
            return '‚≠ê'.repeat(num);
        }

        function getRatingColor(value) {
            const num = parseInt(value);
            if (num === 0 || num === 1) return '#c0392b';
            if (num === 2) return '#f39c12';
            if (num === 3) return '#3498db';
            return '#2ecc71';
        }

        function createRoadIcon(ratingValue) {
            const color = getRatingColor(ratingValue);
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px ${color};"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
        }
        
        function createTempIcon() {
            return L.divIcon({
                className: 'custom-div-icon temp-icon',
                html: `<div style="background-color: ${getRatingColor(3)}; width: 25px; height: 25px; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 10px ${getRatingColor(3)};"></div>`,
                iconSize: [25, 25],
                iconAnchor: [12.5, 12.5], 
                popupAnchor: [0, -12.5]
            });
        }

        // --- New Render Function to populate map and sidebar on load ---
        function renderReportsListAndMap(reportsToRender) {
            const listElement = document.getElementById('reports-list');
            listElement.innerHTML = ''; 
            let hasReports = false;

            // Iterate through the reports object (which is stored by ID)
            for (const reportId in reportsToRender) {
                if (reportsToRender.hasOwnProperty(reportId)) {
                    hasReports = true;
                    const reportData = reportsToRender[reportId];
                    const reportColor = getRatingColor(reportData.rating);
                    const categoryStars = getStarRating(reportData.rating);
                    const layerIndex = parseInt(reportData.rating);
                    const targetLayer = layers[layerIndex];

                    // 1. Add Marker to Map
                    const finalIcon = createRoadIcon(reportData.rating);
                    const finalMarker = L.marker([reportData.lat, reportData.lng], { icon: finalIcon });
                    targetLayer.addLayer(finalMarker); 
                    
                    // Store marker/layer references for deletion/lookup later
                    reportData.marker = finalMarker;
                    reportData.layer = targetLayer;
                    
                    // Prepare Popup content
                    let popupContent = "<b>Rating: " + categoryStars + "</b><br>" + reportData.description;
                    if(reportData.imageUrl) {
                        popupContent += "<br><img src='" + reportData.imageUrl + "' alt='Road condition photo'>";
                    }
                    finalMarker.bindPopup(popupContent);
                    
                    // 2. Add Item to Sidebar List
                    const imgHTML = reportData.imageUrl ? `<img src="${reportData.imageUrl}" class="report-img">` : '';

                    const newReportDiv = document.createElement('div');
                    newReportDiv.className = "report-item";
                    newReportDiv.id = `report-${reportId}`;
                    newReportDiv.style.borderLeftColor = reportColor;
                    newReportDiv.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <strong><span class="stars">${categoryStars}</span> Road Score</strong> 
                            <button onclick="window.deleteReport(${reportId})" class="btn btn-sm p-0 text-muted" title="Delete Report" style="border:none; background:transparent;">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                        <div style="margin-bottom:5px;">${reportData.description}</div>
                        <small>Report ID: ${reportId}</small>
                        ${imgHTML}
                        <small>Location: ${reportData.lat.toFixed(4)}, ${reportData.lng.toFixed(4)}</small>
                        <small>${new Date(reportData.timestamp).toLocaleTimeString()}</small>
                    `;
                    listElement.prepend(newReportDiv); 
                }
            }

            if (!hasReports) {
                listElement.innerHTML = '<p style="color: #999; font-style: italic;">No reports yet.</p>';
            }
        }
        
        // --- DELETE FUNCTION - Opens Modal ---
        window.deleteReport = function(reportId) {
            currentDeleteReportId = reportId;
            document.getElementById('modal-report-id').innerText = `#${reportId}`;

            // Reset modal form fields
            document.getElementById('delete-reason-form').reset();
            document.getElementById('otherReasonText').value = '';
            document.getElementById('otherReasonText').disabled = true;

            // Hide any previous error message
            document.getElementById('other-reason-error').style.display = 'none';

            // Show the Bootstrap Modal
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        };

        // --- EVENT LISTENER FOR RADIO BUTTONS (to enable/disable custom input) ---
        document.querySelectorAll('.reason-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                const otherTextarea = document.getElementById('otherReasonText');
                if (this.id === 'reason6') {
                    otherTextarea.disabled = false;
                    otherTextarea.focus();
                } else {
                    otherTextarea.disabled = true;
                    otherTextarea.value = '';
                }
                document.getElementById('other-reason-error').style.display = 'none';
            });
        });


        // --- MODAL SUBMISSION HANDLER ---
        document.getElementById('delete-reason-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const reportId = currentDeleteReportId;
            if (!reportId || !reports[reportId]) return;

            const selectedRadio = document.querySelector('input[name="deleteReason"]:checked');
            let finalReason = selectedRadio ? selectedRadio.value : 'No Reason Selected';
            
            // --- VALIDATION FOR 'OTHER' OPTION ---
            if (finalReason === 'Other') {
                const customText = document.getElementById('otherReasonText').value.trim();
                if (!customText) {
                    document.getElementById('other-reason-error').style.display = 'block';
                    return; 
                }
                finalReason = `Other: ${customText}`;
            }

            var deleteModalInstance = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            deleteModalInstance.hide(); 

            // --- DELETION LOGIC ---
            
            // 1. Remove marker from the map
            const reportData = reports[reportId];
            reportData.layer.removeLayer(reportData.marker);

            // 2. Remove element from the sidebar list
            const element = document.getElementById(`report-${reportId}`);
            if (element) {
                element.remove();
            }

            // 3. Log the deletion reason
            console.log(`Report ${reportId} deleted. Reason: ${finalReason}`);

            // 4. Remove from the local data object and SAVE
            delete reports[reportId];
            saveReports(reports); // üí° CRITICAL FIX: Save after deletion
            
            // Show "No reports yet" message if the list is empty
            const list = document.getElementById('reports-list');
            if (list.children.length === 0) {
                 list.innerHTML = '<p style="color: #999; font-style: italic;">No reports yet.</p>';
            }

            // 5. Update the status message
            document.getElementById('status-msg').innerText = `üóëÔ∏è Report ${reportId} deleted. Reason: ${finalReason}`;
            document.getElementById('status-msg').style.color = getRatingColor(0); 
            currentDeleteReportId = null; 
            
            // Clear status message after 5 seconds
            setTimeout(() => { document.getElementById('status-msg').innerText = "üó∫Ô∏è Map loaded. Click to pin a location.";
            document.getElementById('status-msg').style.color = getRatingColor(3);}, 5000);
        });


        // ------------------------------------------------------------------
        // --- MAP SETUP & INITIALIZATION ---
        // ------------------------------------------------------------------

        // --- Map Base Layers ---
        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '¬© OpenStreetMap'
        });
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19, attribution: 'Tiles ¬© Esri'
        });

        // --- Overlay Layer Groups (For Filtering by Rating) ---
        var layer0 = L.layerGroup(); 
        var layer1 = L.layerGroup(); 
        var layer2 = L.layerGroup(); 
        var layer3 = L.layerGroup(); 
        var layer4 = L.layerGroup(); 
        var layer5 = L.layerGroup(); 
        
        // Array of layer groups for easier access (Index 0 to 5)
        const layers = [layer0, layer1, layer2, layer3, layer4, layer5];

        // --- Initialize Map ---
        const initialCenter = [8.36, 124.86]; 
        const initialZoom = 13; 

        map = L.map('map', {
            center: initialCenter,
            zoom: initialZoom,
            layers: [streetLayer, layer0, layer1, layer2, layer3, layer4, layer5] 
        });

        // --- Layer Controls for Map Filtering ---
        var baseMaps = {
            "OpenStreetMap": streetLayer,
            "Esri Satellite": satelliteLayer
        };

        var overlayMaps = {
            "0 (Critical)": layer0,
            "‚≠ê (Very Poor)": layer1,
            "‚≠ê‚≠ê (Poor)": layer2,
            "‚≠ê‚≠ê‚≠ê (Average)": layer3,
            "‚≠ê‚≠ê‚≠ê‚≠ê (Good)": layer4,
            "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Excellent)": layer5
        };

        L.control.layers(baseMaps, overlayMaps).addTo(map);
        
        // --- CRITICAL FIX: Force redraw after map object is created (Map loading fix) ---
        setTimeout(function() {
            map.invalidateSize();
            document.getElementById('status-msg').innerText = "üó∫Ô∏è Map loaded. Click to pin a location.";
        }, 100); 

        // ------------------------------------------------------------------
        // --- MAP CLICK HANDLER TO PIN LOCATION ---
        // ------------------------------------------------------------------
        map.on('click', function(e) {
            selectedLat = e.latlng.lat;
            selectedLng = e.latlng.lng;

            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            
            tempMarker = L.marker([selectedLat, selectedLng], { icon: createTempIcon() }).addTo(map);
            tempMarker.bindPopup("Location Pinned! Submit your report.").openPopup();

            document.getElementById('submit-btn').disabled = false;
            document.getElementById('status-msg').innerText = "üìç Location pinned at " + selectedLat.toFixed(4) + ", " + selectedLng.toFixed(4) + ". Select rating and submit.";
            document.getElementById('status-msg').style.color = getRatingColor(3);
        });

        // ------------------------------------------------------------------
        // --- FORM SUBMISSION HANDLER (Updated to save to Local Storage) ---
        // ------------------------------------------------------------------
        document.getElementById('report-form').addEventListener('submit', function(e) {
            e.preventDefault();

            var categoryValue = document.getElementById('category').value; 
            var categoryStars = getStarRating(categoryValue); 
            var reportColor = getRatingColor(categoryValue);
            var desc = document.getElementById('description').value;
            var imageFile = document.getElementById('imageInput').files[0];
            const timestamp = new Date().toISOString(); // Timestamp for logging/sorting

            if (!selectedLat || !selectedLng) {
                document.getElementById('status-msg').innerText = "ERROR: Please pin a location on the map first.";
                document.getElementById('status-msg').style.color = getRatingColor(0);
                return;
            }
            
            if (!categoryValue) {
                document.getElementById('status-msg').innerText = "ERROR: Please select a Road Rating.";
                document.getElementById('status-msg').style.color = getRatingColor(0);
                return;
            }

            function processSubmission(imageUrl) {
                const reportId = (++reportCounter).toString(); // Use string for object key
                
                // üí° NEW: Create the full report object for storage
                const newReport = {
                    id: reportId,
                    rating: categoryValue,
                    description: desc,
                    lat: selectedLat,
                    lng: selectedLng,
                    imageUrl: imageUrl,
                    timestamp: timestamp
                };
                
                // 1. Save the new report to the global object and Local Storage
                reports[reportId] = newReport;
                saveReports(reports); // üí° CRITICAL FIX: Save to Local Storage!
                
                // 2. Clear map and list elements before re-rendering (easier than updating)
                // Remove all markers from layers first
                layers.forEach(layer => layer.clearLayers());
                document.getElementById('reports-list').innerHTML = '';

                // 3. Re-render the map and list with the updated 'reports' object
                renderReportsListAndMap(reports);
                
                // 4. Reset form state
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                
                document.getElementById('report-form').reset();
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('status-msg').innerText = "‚úÖ Report submitted successfully! ID: " + reportId;
                document.getElementById('status-msg').style.color = getRatingColor(4);

                selectedLat = null;
                selectedLng = null;
                
                setTimeout(() => { 
                    document.getElementById('status-msg').innerText = "üó∫Ô∏è Map loaded. Click to pin a location.";
                    document.getElementById('status-msg').style.color = getRatingColor(3);
                }, 5000);
            }

            // Image handling logic
            if (imageFile) {
                var reader = new FileReader();
                reader.onload = function(event) {
                    var base64Image = event.target.result;
                    processSubmission(base64Image);
                };
                reader.readAsDataURL(imageFile);
            } else {
                processSubmission(null);
            }
        });

        // ------------------------------------------------------------------
        // --- INITIAL LOAD LOGIC ---
        // ------------------------------------------------------------------
        window.onload = function() {
            // Load persistent reports from Local Storage
            reports = loadReports(); 

            // Initialize the Map and render the persistent reports onto it and the sidebar
            // This happens after the map object 'map' is fully created above.
            renderReportsListAndMap(reports);
        };
    </script>
</body>
</html>